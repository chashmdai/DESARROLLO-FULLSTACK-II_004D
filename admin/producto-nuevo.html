<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Admin — Nuevo producto</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="../assets/css/admin.css" rel="stylesheet">
</head>
<body class="admin">
  <header id="admin-header"></header>

  <div class="a-layout">
    <aside id="admin-aside" class="a-aside"></aside>

    <main id="admin-main" class="a-main container">
      <nav class="breadcrumb">
        <a href="index.html">Dashboard</a>
        <span class="sep">/</span>
        <a href="productos-listado.html">Productos</a>
        <span class="sep">/</span>
        <span class="muted">Nuevo</span>
      </nav>

      <h1>Nuevo producto</h1>
      <p class="muted">Completa los campos y guarda para agregarlo al inventario.</p>

      <form id="frm" class="form" novalidate>
        <div class="field">
          <label for="fNombre">Nombre *</label>
          <input id="fNombre" type="text" required minlength="2" maxlength="120" placeholder="Ej: Teclado mecánico TKL">
          <div class="help">Obligatorio. Mínimo 2 caracteres.</div>
        </div>

        <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:12px">
          <div class="field">
            <label for="fPrecio">Precio (CLP) *</label>
            <input id="fPrecio" type="number" inputmode="numeric" min="0" step="1" required placeholder="Ej: 39990">
            <div class="help">Solo números, igual o mayor a 0.</div>
          </div>

          <div class="field">
            <label for="fStock">Stock *</label>
            <input id="fStock" type="number" inputmode="numeric" min="0" step="1" required placeholder="Ej: 10">
            <div class="help">Entero, igual o mayor a 0.</div>
          </div>

          <div class="field">
            <label for="fCategoria">Categoría</label>
            <select id="fCategoria">
              <option value="">Seleccione…</option>
              <option>Periféricos</option>
              <option>Audio</option>
              <option>Almacenamiento</option>
              <option>Componentes</option>
              <option>Accesorios</option>
              <option>Otros</option>
            </select>
          </div>
        </div>

        <div class="field">
          <label for="fDescripcion">Descripción</label>
          <textarea id="fDescripcion" rows="4" placeholder="Detalles, materiales, compatibilidad, etc."></textarea>
        </div>

        <div class="grid" style="grid-template-columns:280px 1fr; gap:12px">
          <div class="field">
            <label for="fImagen">Imagen (URL)</label>
            <input id="fImagen" type="url" placeholder="https://…">
            <div class="help">Opcional. Debe ser una URL válida (http/https).</div>
          </div>
          <div class="field">
            <label>Previsualización</label>
            <div class="card" style="display:flex;align-items:center;justify-content:center;height:140px">
              <img id="imgPrev" alt="Sin imagen" style="max-height:120px;max-width:100%;display:none">
              <span id="noPrev" class="muted">Sin imagen</span>
            </div>
          </div>
        </div>

        <div class="field" style="display:flex;align-items:center;gap:8px">
          <input id="fActivo" type="checkbox" checked>
          <label for="fActivo">Producto activo</label>
        </div>

        <div id="errs" class="error hidden"></div>

        <div style="display:flex;gap:10px">
          <button class="btn primary" type="submit">Guardar</button>
          <a class="btn" href="productos-listado.html">Cancelar</a>
        </div>
      </form>
    </main>
  </div>

  <div class="a-dim" aria-hidden="true"></div>

  <script src="../assets/js/datos.js"></script>
  <script src="../assets/js/layout-admin.js"></script>
  <script>
    AX.mountLayout();

    const $frm = document.getElementById('frm');
    const $errs = document.getElementById('errs');
    const $img = document.getElementById('imgPrev');
    const $noPrev = document.getElementById('noPrev');
    const $fImagen = document.getElementById('fImagen');

    function showErrs(list){
      if (!list.length){ $errs.classList.add('hidden'); $errs.innerHTML = ''; return; }
      $errs.classList.remove('hidden');
      $errs.innerHTML = list.map(e => '• ' + e).join('<br>');
    }

    function isHttpUrl(s){
      try { const u = new URL(s); return u.protocol === 'http:' || u.protocol === 'https:'; }
      catch { return false; }
    }

    function updatePreview(){
      const url = $fImagen.value.trim();
      if (url && isHttpUrl(url)){
        $img.src = url;
        $img.style.display = '';
        $noPrev.style.display = 'none';
      } else {
        $img.removeAttribute('src');
        $img.style.display = 'none';
        $noPrev.style.display = '';
      }
    }
    $fImagen.addEventListener('input', updatePreview);

    $frm.addEventListener('submit', (e) => {
      e.preventDefault();

      // Validación nativa de HTML5 primero (required, min, step, minlength, type=url)
      if (!$frm.checkValidity()){
        $frm.reportValidity();
        return;
      }

      // Reglas adicionales de negocio
      const nombre = document.getElementById('fNombre').value.trim();
      const precio = Number(document.getElementById('fPrecio').value);
      const stock  = Number(document.getElementById('fStock').value);
      const categoria = document.getElementById('fCategoria').value.trim();
      const descripcion = document.getElementById('fDescripcion').value.trim();
      const imagen = document.getElementById('fImagen').value.trim();
      const activo = document.getElementById('fActivo').checked;

      const errs = [];
      if (nombre.length < 2) errs.push('El nombre debe tener al menos 2 caracteres.');
      if (!Number.isFinite(precio) || precio < 0) errs.push('El precio debe ser un número válido mayor o igual a 0.');
      if (!Number.isInteger(stock) || stock < 0) errs.push('El stock debe ser un entero mayor o igual a 0.');
      if (imagen && !isHttpUrl(imagen)) errs.push('La imagen debe ser una URL http/https válida.');

      if (errs.length){ showErrs(errs); return; }
      showErrs([]);

      DB.products.add({ nombre, precio, stock, categoria, descripcion, activo, imagen });
      location.href = 'productos-listado.html';
    });

    // Inicializar preview al cargar
    updatePreview();
  </script>
</body>
</html>
