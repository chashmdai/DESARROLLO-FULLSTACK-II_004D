<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Admin — Editar producto</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="../assets/css/admin.css" rel="stylesheet">
</head>
<body class="admin">
  <header id="admin-header"></header>

  <div class="a-layout">
    <aside id="admin-aside" class="a-aside"></aside>

    <main id="admin-main" class="a-main container">
      <nav class="breadcrumb">
        <a href="index.html">Dashboard</a>
        <span class="sep">/</span>
        <a href="productos-listado.html">Productos</a>
        <span class="sep">/</span>
        <span class="muted">Editar</span>
      </nav>

      <h1>Editar producto</h1>

      <div id="notFound" class="card hidden">
        <p class="error">No se encontró el producto solicitado.</p>
        <div style="display:flex; gap:10px; margin-top:8px">
          <a class="btn" href="productos-listado.html">Volver al listado</a>
          <a class="btn primary" href="producto-nuevo.html">Crear nuevo</a>
        </div>
      </div>

      <form id="frm" class="form hidden" novalidate>
        <input id="fId" type="hidden">

        <div class="field">
          <label for="fNombre">Nombre *</label>
          <input id="fNombre" type="text" required minlength="2" maxlength="120" placeholder="Ej: Teclado mecánico TKL">
          <div class="help">Obligatorio. Mínimo 2 caracteres.</div>
        </div>

        <div class="grid" style="grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:12px">
          <div class="field">
            <label for="fPrecio">Precio (CLP) *</label>
            <input id="fPrecio" type="number" inputmode="numeric" min="0" step="1" required placeholder="Ej: 39990">
            <div class="help">Solo números, igual o mayor a 0.</div>
          </div>

          <div class="field">
            <label for="fStock">Stock *</label>
            <input id="fStock" type="number" inputmode="numeric" min="0" step="1" required placeholder="Ej: 10">
            <div class="help">Entero, igual o mayor a 0.</div>
          </div>

          <div class="field">
            <label for="fCategoria">Categoría</label>
            <select id="fCategoria">
              <option value="">Seleccione…</option>
              <option>Periféricos</option>
              <option>Audio</option>
              <option>Almacenamiento</option>
              <option>Componentes</option>
              <option>Accesorios</option>
              <option>Otros</option>
            </select>
          </div>
        </div>

        <div class="field">
          <label for="fDescripcion">Descripción</label>
          <textarea id="fDescripcion" rows="4" placeholder="Detalles, materiales, compatibilidad, etc."></textarea>
        </div>

        <div class="grid" style="grid-template-columns:280px 1fr; gap:12px">
          <div class="field">
            <label for="fImagen">Imagen (URL)</label>
            <input id="fImagen" type="url" placeholder="https://…">
            <div class="help">Opcional. Debe ser una URL válida (http/https).</div>
          </div>
          <div class="field">
            <label>Previsualización</label>
            <div class="card" style="display:flex;align-items:center;justify-content:center;height:140px">
              <img id="imgPrev" alt="Sin imagen" style="max-height:120px;max-width:100%;display:none">
              <span id="noPrev" class="muted">Sin imagen</span>
            </div>
          </div>
        </div>

        <div class="field" style="display:flex;align-items:center;gap:8px">
          <input id="fActivo" type="checkbox">
          <label for="fActivo">Producto activo</label>
        </div>

        <div id="errs" class="error hidden"></div>

        <div style="display:flex;gap:10px">
          <button class="btn primary" type="submit">Guardar cambios</button>
          <a class="btn" href="productos-listado.html">Cancelar</a>
        </div>
      </form>
    </main>
  </div>

  <div class="a-dim" aria-hidden="true"></div>

  <script src="../assets/js/datos.js"></script>
  <script src="../assets/js/layout-admin.js"></script>
  <script>
    AX.mountLayout();

    function qs(k){ return new URLSearchParams(location.search).get(k); }
    function isHttpUrl(s){ try{ const u=new URL(s); return u.protocol==='http:'||u.protocol==='https:'; }catch{ return false; } }
    function showErrs(list){
      const box = document.getElementById('errs');
      if (!list.length){ box.classList.add('hidden'); box.innerHTML=''; return; }
      box.classList.remove('hidden');
      box.innerHTML = list.map(e=>'• '+e).join('<br>');
    }
    function updatePreview(){
      const url = document.getElementById('fImagen').value.trim();
      const img = document.getElementById('imgPrev');
      const none = document.getElementById('noPrev');
      if (url && isHttpUrl(url)){ img.src=url; img.style.display=''; none.style.display='none'; }
      else { img.removeAttribute('src'); img.style.display='none'; none.style.display=''; }
    }

    (function init(){
      const id = qs('id');
      const notFound = document.getElementById('notFound');
      const frm = document.getElementById('frm');
      if (!id){ notFound.classList.remove('hidden'); return; }
      const p = DB.products.get(id);
      if (!p){ notFound.classList.remove('hidden'); return; }

      frm.classList.remove('hidden');
      document.getElementById('fId').value = p.id;
      document.getElementById('fNombre').value = p.nombre || '';
      document.getElementById('fPrecio').value = Number(p.precio || 0);
      document.getElementById('fStock').value = Number(p.stock || 0);
      document.getElementById('fCategoria').value = p.categoria || '';
      document.getElementById('fDescripcion').value = p.descripcion || '';
      document.getElementById('fImagen').value = p.imagen || '';
      document.getElementById('fActivo').checked = !!p.activo;
      updatePreview();
    })();

    document.getElementById('fImagen').addEventListener('input', updatePreview);

    document.getElementById('frm').addEventListener('submit', function(e){
      e.preventDefault();
      const form = this;

      if (!form.checkValidity()){ form.reportValidity(); return; }

      const id = document.getElementById('fId').value;
      const nombre = document.getElementById('fNombre').value.trim();
      const precio = Number(document.getElementById('fPrecio').value);
      const stock  = Number(document.getElementById('fStock').value);
      const categoria = document.getElementById('fCategoria').value.trim();
      const descripcion = document.getElementById('fDescripcion').value.trim();
      const imagen = document.getElementById('fImagen').value.trim();
      const activo = document.getElementById('fActivo').checked;

      const errs = [];
      if (nombre.length < 2) errs.push('El nombre debe tener al menos 2 caracteres.');
      if (!Number.isFinite(precio) || precio < 0) errs.push('El precio debe ser un número válido mayor o igual a 0.');
      if (!Number.isInteger(stock) || stock < 0) errs.push('El stock debe ser un entero mayor o igual a 0.');
      if (imagen && !isHttpUrl(imagen)) errs.push('La imagen debe ser una URL http/https válida.');

      if (errs.length){ showErrs(errs); return; }
      showErrs([]);

      const ok = DB.products.update(id, { nombre, precio, stock, categoria, descripcion, activo, imagen });
      if (ok) location.href = 'productos-listado.html';
      else alert('No se pudo actualizar: producto no encontrado.');
    });
  </script>
</body>
</html>
