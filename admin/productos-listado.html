<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Admin â€” Productos (Listado)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="../assets/css/admin.css" rel="stylesheet">
</head>
<body class="admin">
  <header id="admin-header"></header>

  <div class="a-layout">
    <aside id="admin-aside" class="a-aside"></aside>

    <main id="admin-main" class="a-main container">
      <nav class="breadcrumb">
        <a href="index.html">Dashboard</a>
        <span class="sep">/</span>
        <span class="muted">Productos</span>
        <span class="sep">/</span>
        <span class="muted">Listado</span>
      </nav>

      <h1>Productos</h1>

      <div class="toolbar">
        <div class="search">
          <span>ðŸ”Ž</span>
          <input id="q" type="text" placeholder="Buscar por id, nombre o categorÃ­aâ€¦" aria-label="Buscar">
        </div>
        <span class="spacer"></span>
        <a class="btn primary" href="producto-nuevo.html">Nuevo producto</a>
      </div>

      <div id="empty" class="card hidden">
        <p class="muted">No hay productos cargados.</p>
        <a class="btn primary" href="producto-nuevo.html">Crear el primero</a>
      </div>

      <div id="wrap" class="table-wrap hidden">
        <table class="table-sm" id="tabla">
          <thead>
            <tr>
              <th style="width:84px">Img</th>
              <th>Nombre</th>
              <th style="width:160px">CategorÃ­a</th>
              <th style="width:120px">Precio</th>
              <th style="width:100px">Stock</th>
              <th style="width:100px">Activo</th>
              <th class="right" style="width:240px">Acciones</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </main>
  </div>

  <div class="a-dim" aria-hidden="true"></div>

  <script src="../assets/js/datos.js"></script>
  <script src="../assets/js/layout-admin.js"></script>
  <script>
    AX.mountLayout();

    const $q = document.getElementById('q');
    const $empty = document.getElementById('empty');
    const $wrap = document.getElementById('wrap');
    const $tbody = document.getElementById('tbody');

    const CLP = new Intl.NumberFormat('es-CL', { style:'currency', currency:'CLP', maximumFractionDigits:0 });

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    function thumb(p){
      if (p && p.imagen){
        const url = escapeHtml(p.imagen);
        return `<img src="${url}" alt="" style="width:64px;height:64px;object-fit:cover;border-radius:8px" onerror="this.style.display='none'">`;
      }
      return `<div class="muted" style="width:64px;height:64px;border:1px solid #e5e7eb;border-radius:8px;display:flex;align-items:center;justify-content:center">â€”</div>`;
    }

    function row(p){
      const id = p.id;
      const editar = `producto-editar.html?id=${encodeURIComponent(id)}`;
      const ver = `producto-mostrar.html?id=${encodeURIComponent(id)}`;
      const activo = p.activo ? '<span class="badge">SÃ­</span>' : '<span class="badge" style="background:#fee2e2;border-color:#fecaca">No</span>';
      return `
        <tr data-id="${id}">
          <td>${thumb(p)}</td>
          <td>
            <div style="font-weight:600">${escapeHtml(p.nombre || '')}</div>
            <div class="muted" style="font-size:.9rem">#${escapeHtml(String(id))}</div>
          </td>
          <td>${escapeHtml(p.categoria || 'â€”')}</td>
          <td>${CLP.format(Number(p.precio || 0))}</td>
          <td>${escapeHtml(String(p.stock ?? 0))}</td>
          <td>${activo}</td>
          <td class="right">
            <a class="btn" href="${ver}">Ver</a>
            <a class="btn" href="${editar}">Editar</a>
            <button class="btn danger" data-del>Eliminar</button>
          </td>
        </tr>
      `;
    }

    function getData(){
      try { return (DB && DB.products && DB.products.list) ? DB.products.list() : []; }
      catch { return []; }
    }

    function render(term){
      const all = getData();
      const text = String(term || '').toLowerCase().trim();

      const data = !text ? all : all.filter(p => {
        const blob = [String(p.id||''), p.nombre||'', p.categoria||''].join(' ').toLowerCase();
        return blob.includes(text);
      });

      const has = data.length > 0;
      $empty.classList.toggle('hidden', has);
      $wrap.classList.toggle('hidden', !has);

      if (!has){ $tbody.innerHTML = ''; return; }

      let html = '';
      for (let i=0;i<data.length;i++) html += row(data[i]);
      $tbody.innerHTML = html;
    }

    $q.addEventListener('input', () => render($q.value));

    document.addEventListener('click', (e) => {
      const btn = e.target.closest('[data-del]');
      if (!btn) return;
      const tr = btn.closest('tr');
      const id = tr?.getAttribute('data-id');
      if (!id) return;

      if (confirm('Â¿Eliminar producto #' + id + '?')) {
        try {
          const ok = DB && DB.products && DB.products.remove ? DB.products.remove(id) : false;
          if (ok) {
            tr.remove();
            render($q.value);
          } else {
            alert('No se pudo eliminar (no encontrado).');
          }
        } catch {
          alert('OcurriÃ³ un error al eliminar.');
        }
      }
    });

    render('');
  </script>
</body>
</html>