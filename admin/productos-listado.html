<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Admin â€” Productos (Listado)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="../assets/css/admin.css" rel="stylesheet">
</head>
<body class="admin">
  <header id="admin-header"></header>

  <div class="a-layout">
    <aside id="admin-aside" class="a-aside"></aside>

    <main id="admin-main" class="a-main container">
      <nav class="breadcrumb">
        <a href="index.html">Dashboard</a>
        <span class="sep">/</span>
        <span class="muted">Productos</span>
        <span class="sep">/</span>
        <span class="muted">Listado</span>
      </nav>

      <h1>Productos</h1>

      <div class="toolbar">
        <div class="search">
          <span>ðŸ”Ž</span>
          <input id="q" type="text" placeholder="Buscar por id, nombre o categorÃ­aâ€¦" aria-label="Buscar">
        </div>
        <span class="spacer"></span>
        <a id="btnNewTop" class="btn primary" href="producto-nuevo.html">Nuevo producto</a>
      </div>

      <div id="empty" class="card hidden">
        <p class="muted">No hay productos cargados.</p>
        <a class="btn primary" href="producto-nuevo.html">Crear el primero</a>
      </div>

      <div id="tableWrap" class="table-wrap hidden">
        <table class="table-sm" id="tabla">
          <thead>
            <tr>
              <th style="width:90px">ID</th>
              <th>Nombre</th>
              <th style="width:140px">Precio</th>
              <th style="width:90px">Stock</th>
              <th style="width:120px">Estado</th>
              <th class="right" style="width:230px">Acciones</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </main>
  </div>

  <div class="a-dim" aria-hidden="true"></div>

  <script src="../assets/js/datos.js"></script>
  <script src="../assets/js/layout-admin.js"></script>
  <script>
    AX.mountLayout();

    const $q = document.getElementById('q');
    const $tbody = document.getElementById('tbody');
    const $wrap = document.getElementById('tableWrap');
    const $empty = document.getElementById('empty');
    const $btnNewTop = document.getElementById('btnNewTop');

    const CLP = new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP', maximumFractionDigits: 0 });

    function badgeEstado(p) {
      if (p.activo && Number(p.stock) > 0) return '<span class="badge ok">Activo</span>';
      if (Number(p.stock) <= 0) return '<span class="badge warn">Sin stock</span>';
      return '<span class="badge">Inactivo</span>';
    }

    function row(p) {
      return `
        <tr data-id="${p.id}">
          <td>${p.id}</td>
          <td>${escapeHtml(p.nombre || '')}</td>
          <td>${CLP.format(Number(p.precio || 0))}</td>
          <td>${Number(p.stock || 0)}</td>
          <td>${badgeEstado(p)}</td>
          <td class="right">
            <a class="btn" href="producto-mostrar.html?id=${encodeURIComponent(p.id)}">Ver</a>
            <a class="btn" href="producto-editar.html?id=${encodeURIComponent(p.id)}">Editar</a>
            <button class="btn danger" data-del>Eliminar</button>
          </td>
        </tr>
      `;
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    function render(term){
      const data = DB.products.list(term);
      const has = data.length > 0;

      $btnNewTop.classList.toggle('hidden', !has);
      $wrap.classList.toggle('hidden', !has);
      $empty.classList.toggle('hidden', has);

      if (!has){ $tbody.innerHTML = ''; return; }

      let html = '';
      for (let i=0;i<data.length;i++){ html += row(data[i]); }
      $tbody.innerHTML = html;
    }

    $q.addEventListener('input', () => render($q.value));

    document.addEventListener('click', (e) => {
      const btn = e.target.closest('[data-del]');
      if (!btn) return;
      const tr = btn.closest('tr');
      const id = tr?.getAttribute('data-id');
      if (!id) return;
      if (confirm('Â¿Eliminar producto #' + id + '?')) {
        if (DB.products.remove(id)) {
          tr.remove();
          render($q.value);
        } else {
          alert('No se pudo eliminar (no encontrado).');
        }
      }
    });

    render('');
  </script>
</body>
</html>
